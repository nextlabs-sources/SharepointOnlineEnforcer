#!/bin/bash
#
# DESCRIPTION
#	This script generates a number of bash variables used in PCV and release build.
#
#	The main objective is to make it easy to rebuild in case of build error. Also build
#	parameters are explicit so that it is easy to understand or override. This script
#	generates a ./build.config file to be used by ./buildAll. Run this script after ./setEnv.
#
# USAGE
#	See printUsage()
#
# NOTES
#	When bash script is run from Hudson, the output string of $(hostname), $(whoami) is return
#	with a trailing '\r'. Use tr to remove the trailing '\r' ($(hostname | tr -d "\r")).


echo "NextLabs SharePoint Products Build Configuration Script"
echo "Specify --help for more information"


#
# Process commandline parameters
#

# ------------------------------
# printUsage()

function printUsage
{
	echo "usage: configure [--type=release|pcv_smdc|pcv_cdc|dev] [--mapBuildRoot=<drive>]"
	echo "  mapBuildRoot  Use short path for NLBUILDROOT to avoid Cygwin and InstallShield"
	echo "                path length limitation. Specify a drive letter that NLBUILDROOT is"
	echo "                mapped to (e.g., --mapBuildRoot=k). IMPORTANT: Beware that if you"
	echo "                have two Hudson projects setup to use the same drive, you can"
	echo "                potentially have one project changing drive mapping of another"
	echo "                in the middle of a build and produce unpredictible result. In this"
	echo "                case, you should use a different drive mapping for a second"
	echo "                project."
	echo "  type          Build configuration type. Default is dev. Valid values are:"
	echo "                  release"
	echo "                    BUILD_NUMBER must be specified"
	echo "                    BUILDTYPE=release"
	echo "                    PREFAST=0"
	echo "                  pcv_smdc or pcv_cdc"
	echo "                    BUILD_NUMBER is generated by this script"
	echo "                    BUILDTYPE=release|debug"
	echo "                    PREFAST=1"
	echo "                  dev"
	echo "                    BUILD_NUMBER is generated by this script"
	echo "                    BUILDTYPE=release|debug"
	echo "                    PREFAST=0|1"
	echo ""
	echo "Environment variables used by this script include:"
	echo "  BUILD_NUMBER=<#>         Valid only for --type=release. Otherwise, auto-generated."
	echo "  BUILDTYPE=release|debug   Always release for --type=release"
	echo "  NLEXTERNALDIR=<path>      Must be set by you"
	echo "  NLBUILDROOT=<path>        Will always be set to current directory"
	echo "  PREFAST=0|1"
	echo ""
	echo "Environment Variables:"
	echo "  BUILD_NUMBER     = $BUILD_NUMBER"
	echo "  BUILDTYPE        = $BUILDTYPE"
	echo "  OFFICIALCERT     = $OFFICIALCERT"
	echo "  PREFAST          = $PREFAST"
	echo "  NLBUILDROOT      = $NLBUILDROOT"
	echo "  NLEXTERNALDIR    = $NLEXTERNALDIR"
}

# Help
if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
	printUsage
	exit 0
fi

# Parse arguements
CONFIG_TYPE=dev
MAP_BUILD_ROOT=

while [ $# -gt 0 ]; do
	if [ "${1%%=*}" == "--type" ]; then
		CONFIG_TYPE=${1##*=}
	elif [ "${1%%=*}" == "--mapBuildRoot" ]; then
		MAP_BUILD_ROOT=${1##*=}
	fi

	shift
done

# Check for errors
if [ "$CONFIG_TYPE" != "release" ] &&  [ "$CONFIG_TYPE" != "pcv_smdc" ] \
	&&  [ "$CONFIG_TYPE" != "pcv_cdc" ] &&  [ "$CONFIG_TYPE" != "dev" ]; then
	echo "### ERROR: Invalid config type $CONFIG_TYPE"
	exit 1
fi

# Print arguements
echo "INFO: Parameters:"
echo "  CONFIG_TYPE      = $CONFIG_TYPE"
echo "  MAP_BUILD_ROOT   = $MAP_BUILD_ROOT"


#
# Check for errors
#

MAP_PATH=${MAP_BUILD_ROOT}:/
NLEXTERNALDIR=`cygpath -m "$NLEXTERNALDIR"`

if [ "$MAP_BUILD_ROOT" != "" ] && [ ! -d $MAP_PATH ]; then
	echo "### ERROR: Invalid mapped build root $MAP_PATH"
	exit 1
fi

if [ "$NLEXTERNALDIR" == "" ]; then
	echo "### ERROR: Missing variable \$NLEXTERNALDIR"
	exit 1
fi

if [ ! -d $NLEXTERNALDIR ]; then
	echo "### ERROR: Missing external directory $NLEXTERNALDIR"
	exit 1
fi

if [ "$BUILD_NUMBER" == "" ] || [ $BUILD_NUMBER -eq 0 ]; then
	echo "### ERROR: Missing or invalid \$BUILD_NUMBER"
	exit 1
fi


#
# Prepare variables
#

# Set project root
if [ "$MAP_BUILD_ROOT" == "" ]; then
	NLBUILDROOT=$(cygpath -m $(pwd) | tr -d "\r")
else
	NLBUILDROOT=${MAP_BUILD_ROOT}:
fi

# Compiler variables
BUILDTYPE=release
PREFAST=0
OFFICIALCERT=1
VERSION_PROJECT=1.2.0.$BUILD_NUMBER
VERSION_BUILD=$BUILD_NUMBER
VERSION_BUILD_SHORT=$BUILD_NUMBER
MAKE_CFLAGS_32="-k OFFICIALCERT=$OFFICIALCERT BUILDTYPE=$BUILDTYPE TARGETENVARCH=x86 PREFAST=$PREFAST VERSION_BUILD=$VERSION_BUILD"
MAKE_CFLAGS_64="-k OFFICIALCERT=$OFFICIALCERT BUILDTYPE=$BUILDTYPE TARGETENVARCH=x64 PREFAST=$PREFAST VERSION_BUILD=$VERSION_BUILD"
MAKE_CSFLAGS="-k OFFICIALCERT=$OFFICIALCERT BUILDTYPE=$BUILDTYPE PREFAST=$PREFAST VERSION_BUILD=$VERSION_BUILD"
MAKE_INSTALLFLAGS="-k OFFICIALCERT=$OFFICIALCERT BUILDTYPE=release VERSION_BUILD=$VERSION_BUILD"

# Project info
BUILD_DATE=$(date +"%Y%m%d")
BUILD_DATE_LONG=$(date +"%Y%m%d%H%M")

# Dependencies used by Makefile.xlib
if [ "$XLIB_POLICY_ADAPTOR_SDK_ZIP_FILE" == "" ]; then
	XLIB_POLICY_ADAPTOR_SDK_ZIP_FILE="S:/releases/PolicyAdapterSDK/6.2.0.0/PolicyAdapterSDK-6.2.0.0-274-20121017.zip"
fi

# Locations used by Makefile.publish
SYNC_FOLDER_ROOT=s:/global/Us2Cdc/engineering

if [ "$CONFIG_TYPE" == "release" ]; then
	REPOSITORY_ROOT=s:/build/release_candidate
else
	REPOSITORY_ROOT=s:/build/pcv
fi

#
# Generate build.config
#
(
cat <<EOT
#!/bin/bash
#
# Description
#	This script contains variable to be used by ./buildAll script. It can also be used to
#	setup the environment for manual compilation. It is especially useful for partial
#	rebuilding after fixing compilation problem or incremental build after bug fix.
#
# WARNING
#	This file is generated by ./configure. You may edit this file for debugging because
#	changes will be overriden when ./configure is run.

export CONFIG_TYPE=$CONFIG_TYPE
export VERSION_PROJECT=$VERSION_PROJECT
export BUILD_NUMBER=$BUILD_NUMBER
export VERSION_BUILD=$VERSION_BUILD
export VERSION_BUILD_SHORT=$VERSION_BUILD_SHORT
export BUILDTYPE=$BUILDTYPE
export BUILD_DATE=$BUILD_DATE
export BUILD_DATE_LONG=$BUILD_DATE_LONG
export PREFAST=$PREFAST
export OFFICIALCERT=$OFFICIALCERT

export XLIB_POLICY_ADAPTOR_SDK_ZIP_FILE=$XLIB_POLICY_ADAPTOR_SDK_ZIP_FILE

export REPOSITORY_ROOT=$REPOSITORY_ROOT
export SYNC_FOLDER_ROOT=$SYNC_FOLDER_ROOT

export NLBUILDROOT=$NLBUILDROOT
export NLEXTERNALDIR=$NLEXTERNALDIR
export MSENFORCECOMMON=W:

export MAKE_CFLAGS_32="$MAKE_CFLAGS_32"
export MAKE_CFLAGS_64="$MAKE_CFLAGS_64"
export MAKE_CSFLAGS="$MAKE_CSFLAGS"
export MAKE_INSTALLFLAGS="$MAKE_INSTALLFLAGS"
export PSCORE=$PSCORE
EOT
) > build.config

# Print content of build.config
echo ""
echo "INFO: build.config"

cat build.config

# Update SPO host app and SPFX app version info
echo "pwsh $NLBUILDROOT/build/UpdateSPOAppsVersion.ps1 -FilePathAppManifest $NLBUILDROOT/prod/SPOLE/SPOLE/AppManifest.xml -FilePathPackageSolution $NLBUILDROOT/prod/SPOESPFx/config/package-solution.json -BuildNumber $BUILD_NUMBER"
pwsh $NLBUILDROOT/build/UpdateSPOAppsVersion.ps1 -FilePathAppManifest $NLBUILDROOT/prod/SPOLE/SPOLE/AppManifest.xml -FilePathPackageSolution $NLBUILDROOT/prod/SPOESPFx/config/package-solution.json -BuildNumber $BUILD_NUMBER

# Call to update version in AppManifest.xml and NLSPOLEventHandler\Makefile
#perl $NLBUILDROOT/build/prepareManifest.pl --buildType=$CONFIG_TYPE --buildNum=$BUILD_NUMBER
